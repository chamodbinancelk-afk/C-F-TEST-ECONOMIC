// required libraries
import { load } from 'cheerio';
import moment from 'moment-timezone';

// üõë CONSTANTS
const BOT_TOKEN = "5389567211:AAG0ksuNyQ1AN0JpcZjBhQQya9-jftany2A";
const CHAT_ID = "-1003111341307";
const FOREX_URL = "https://www.forexfactory.com/calendar";
const TELEGRAM_API_URL = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`; 
const TIMEZONE = 'Asia/Colombo';


/**
 * Actual ‡∂Ö‡∂ú‡∂∫ Previous ‡∂Ö‡∂ú‡∂∫ ‡∑É‡∂∏‡∂ú ‡∑É‡∂Ç‡∑É‡∂±‡∑ä‡∂Ø‡∂±‡∂∫ ‡∂ö‡∂ª ‡∑Ä‡∑ô‡∑Ö‡∂≥‡∂¥‡∑ú‡∑Ö ‡∂¥‡∑î‡∂ª‡∑ù‡∂ö‡∂Æ‡∂±‡∂∫ ‡∂Ω‡∂∂‡∑è ‡∂Ø‡∑ô‡∂∫‡∑í (‡∑É‡∑í‡∂Ç‡∑Ñ‡∂Ω‡∑ô‡∂±‡∑ä).
 */
function analyzeComparison(actual, previous) {
    try {
        const a = parseFloat(actual.replace('%', '').trim());
        const p = parseFloat(previous.replace('%', '').trim());

        if (isNaN(a) || isNaN(p)) {
            throw new Error("Invalid number format");
        }
        
        if (a > p) {
            return {
                comparison: `‡∂¥‡∑ô‡∂ª ‡∂Ø‡∂≠‡∑ä‡∂≠‡∑Ä‡∂Ω‡∂ß ‡∑Ä‡∂©‡∑è ‡∂â‡∑Ñ‡∑Ö‡∂∫‡∑í (${actual})`,
                reaction: "üìâ Forex ‡∑É‡∑Ñ Crypto ‡∑Ä‡∑ô‡∑Ö‡∂≥‡∂¥‡∑ú‡∑Ö ‡∂¥‡∑Ñ‡∑Ö‡∂ß ‡∂∫‡∑è ‡∑Ñ‡∑ê‡∂ö‡∑í‡∂∫‡∑í"
            };
        } else if (a < p) {
            return {
                comparison: `‡∂¥‡∑ô‡∂ª ‡∂Ø‡∂≠‡∑ä‡∂≠‡∑Ä‡∂Ω‡∂ß ‡∑Ä‡∂©‡∑è ‡∂¥‡∑Ñ‡∑Ö‡∂∫‡∑í (${actual})`,
                reaction: "üìà Forex ‡∑É‡∑Ñ Crypto ‡∑Ä‡∑ô‡∑Ö‡∂≥‡∂¥‡∑ú‡∑Ö ‡∂â‡∑Ñ‡∑Ö‡∂ß ‡∂∫‡∑è ‡∑Ñ‡∑ê‡∂ö‡∑í‡∂∫‡∑í"
            };
        } else {
            return {
                comparison: `‡∂¥‡∑ô‡∂ª ‡∂Ø‡∂≠‡∑ä‡∂≠‡∑Ä‡∂Ω‡∂ß ‡∑É‡∂∏‡∑è‡∂±‡∂∫‡∑í (${actual})`,
                reaction: "‚öñ Forex ‡∑É‡∑Ñ Crypto ‡∑Ä‡∑ô‡∑Ö‡∂≥‡∂¥‡∑ú‡∑Ö ‡∑É‡∑ä‡∂Æ‡∑è‡∑Ä‡∂ª‡∂∫‡∑ô‡∑Ñ‡∑í ‡∂¥‡∑Ä‡∂≠‡∑ì"
            };
        }
    } catch (error) {
        return {
            comparison: `Actual: ${actual}`,
            reaction: "üîç ‡∑Ä‡∑ô‡∑Ö‡∂≥‡∂¥‡∑ú‡∑Ö ‡∂¥‡∑ä‚Äç‡∂ª‡∂≠‡∑í‡∂†‡∑è‡∂ª ‡∂Ö‡∂±‡∑è‡∑Ä‡∑ê‡∂ö‡∑í ‡∂ö‡∑Ö ‡∂±‡∑ú‡∑Ñ‡∑ê‡∂ö"
        };
    }
}

/**
 * Forex Factory ‡∑Ä‡∑ô‡∂≠‡∑í‡∂±‡∑ä ‡∂±‡∑Ä‡∂≠‡∂∏ ‡∑É‡∂∏‡∑ä‡∂¥‡∑ñ‡∂ª‡∑ä‡∂´ ‡∂ö‡∑Ö ‡∂Ü‡∂ª‡∑ä‡∂Æ‡∑í‡∂ö ‡∑É‡∑í‡∂Ø‡∑î‡∑Ä‡∑ì‡∂∏ ‡∂Ω‡∂∂‡∑è ‡∂ú‡∂±‡∑ì.
 */
async function getLatestEvent() {
    try {
        const response = await fetch(FOREX_URL, {
            headers: {
                'User-Agent': 'Cloudflare Worker Scraper' 
            }
        });

        if (!response.ok) {
            throw new Error(`Failed to fetch Forex Factory: ${response.statusText}`);
        }
        
        const html = await response.text();
        const $ = load(html);
        const rows = $('.calendar__row');

        for (let i = rows.length - 1; i >= 0; i--) {
            const row = rows.eq(i);
            const eventId = row.attr('data-event-id');

            const currency = row.find('.calendar__currency').text().trim();
            const title = row.find('.calendar__event').text().trim();
            const actual = row.find('.calendar__actual').text().trim();
            const previous = row.find('.calendar__previous').text().trim() || "0";
            const time = row.find('.calendar__time').text().trim();
            
            // ‚úÖ Impact Extraction Logic
            const impactSpan = row.find('.calendar__impact').find('span[title]');
            
            const impact = impactSpan.attr('title') || "Unknown";
            
            if (eventId && currency && title && actual && actual !== "-") {
                return {
                    id: eventId,
                    currency: currency,
                    title: title,
                    time: time,
                    actual: actual,
                    previous: previous,
                    impact: impact 
                };
            }
        }
        return null;
    } catch (error) {
        console.error("Error fetching or parsing data:", error.message);
        return null;
    }
}

/**
 * Telegram ‡∑Ñ‡∂ª‡∑Ñ‡∑è ‡∑É‡∑í‡∂Ø‡∑î‡∑Ä‡∑ì‡∂∏‡∑ä ‡∑Ä‡∑í‡∑É‡∑ä‡∂≠‡∂ª ‡∂∫‡∑Ä‡∂∫‡∑í.
 */
async function sendEvent(event) {
    const now = moment().tz(TIMEZONE).format('YYYY-MM-DD HH:mm:ss');

    let impactLevel;
    switch (event.impact) {
        case "High Impact Expected":
            impactLevel = "üî¥ High";
            break;
        case "Medium Impact Expected":
            impactLevel = "üü† Medium";
            break;
        case "Low Impact Expected":
            impactLevel = "üü¢ Low";
            break;
        default:
            impactLevel = "‚ö™ Unknown";
    }

    const { comparison, reaction } = analyzeComparison(event.actual, event.previous);

    const msg = `üõë *Breaking News* üì∞

‚è∞ *Date & Time:* ${now}

üåç *Currency:* ${event.currency}

üìå *Headline:* ${event.title}

üî• *Impact:* ${impactLevel}

üìà *Actual:* ${event.actual}
üìâ *Previous:* ${event.previous}

üîç *Details:* ${comparison}

üìà *Market Reaction Forecast:* ${reaction}

üöÄ *Dev : Mr Chamo üá±üá∞*`;

    try {
        const payload = {
            chat_id: CHAT_ID,
            text: msg,
            parse_mode: "Markdown"
        };

        const response = await fetch(TELEGRAM_API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Telegram API failed: ${response.status} - ${errorText}`);
        }
        console.log(`Sent event: ${event.id} - ${event.title}`);
        return true;
    } catch (error) {
        console.error("Error sending Telegram message:", error.message);
        return false;
    }
}

/**
 * ‡∂¥‡∑ä‚Äç‡∂ª‡∂∞‡∑è‡∂± ‡∂ö‡∑è‡∂ª‡∑ä‡∂∫‡∂∫ ‡∂â‡∂ß‡∑î ‡∂ö‡∂ª‡∂± Logic ‡∂ö‡∑ú‡∂ß‡∑É (KV Storage ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∂∫‡∑ô‡∂±‡∑ä).
 * üí° env object ‡∂ë‡∂ö‡∑ö KV binding ‡∂ë‡∂ö Cloudflare ‡∂∏‡∂ú‡∑í‡∂±‡∑ä ‡∑É‡∂¥‡∂∫‡∂±‡∑î ‡∂Ω‡∂∂‡∂∫‡∑í.
 */
async function mainLogic(env) {
    // KV ‡∂≠‡∑î‡∑Ö ‡∂Ö‡∑Ä‡∑É‡∑è‡∂± ID ‡∂ë‡∂ö ‡∂ú‡∂∂‡∂©‡∑è ‡∂ö‡∑í‡∂ª‡∑ì‡∂∏‡∂ß ‡∂∑‡∑è‡∑Ä‡∑í‡∂≠‡∑è ‡∂ö‡∂ª‡∂± Key ‡∂ë‡∂ö
    const HISTORY_KEY = 'LAST_SENT_EVENT_ID';
    
    // üõë FOREX_HISTORY KV binding ‡∂ë‡∂ö Cloudflare ‡∂∏‡∂ú‡∑í‡∂±‡∑ä ‡∑É‡∂¥‡∂∫‡∂± ‡∂∂‡∑ê‡∑Ä‡∑í‡∂±‡∑ä,
    // ‡∂ë‡∂∫ env.FOREX_HISTORY ‡∂Ω‡∑ô‡∑É ‡∑É‡∑ò‡∂¢‡∑î‡∑Ä‡∂∏ ‡∂¥‡∑ä‚Äç‡∂ª‡∑Ä‡∑ö‡∑Å ‡∑Ä‡∑ö.
    const kvStore = env.FOREX_HISTORY;

    try {
        const event = await getLatestEvent();

        if (event) {
            // 1. KV ‡∂ë‡∂ö‡∑ô‡∂±‡∑ä ‡∂Ö‡∑Ä‡∑É‡∂±‡∑ä ‡∑Ä‡∂ª‡∂ß ‡∂∫‡∑ê‡∑Ä‡∑ñ ID ‡∂ë‡∂ö ‡∂ö‡∑í‡∂∫‡∑Ä‡∑ì‡∂∏
            const lastSentId = await kvStore.get(HISTORY_KEY);
            
            if (lastSentId === event.id) {
                // üõë ‡∂¥‡∑î‡∂±‡∂ª‡∑è‡∑Ä‡∂ª‡∑ä‡∂≠‡∂±‡∂∫ ‡∂±‡∑Ä‡∂≠‡∑ä‡∑Ä‡∂∫‡∑í
                console.log(`Event ${event.id} already sent. Skipping.`);
                return;
            }

            console.log("Found NEW event. Attempting to send to Telegram:", event.id);
            
            // 2. ‡∂¥‡∂´‡∑í‡∑Ä‡∑í‡∂©‡∂∫ ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏
            const success = await sendEvent(event);

            // 3. ‡∑É‡∑è‡∂ª‡∑ä‡∂Æ‡∂ö ‡∂±‡∂∏‡∑ä, ‡∂±‡∑Ä ID ‡∂ë‡∂ö KV ‡∂ë‡∂ö‡∂ß ‡∂Ω‡∑í‡∑Ä‡∑ì‡∂∏
            if (success) {
                await kvStore.put(HISTORY_KEY, event.id);
                console.log(`Successfully saved NEW event ID ${event.id} to KV.`);
            }

        } else {
            console.log("No new completed event (Actual value missing) in the current scan.");
        }
    } catch (e) {
        console.error("Main logic error:", e.message);
    }
}

// üõë CLOUDFLARE WORKER EXPORT (KV ‡∑Ä‡∑ô‡∂≠ env object ‡∂ë‡∂ö ‡∂∫‡∑ê‡∑Ä‡∑ì‡∂∏)
export default {
    
    // fetch ‡∑É‡∑Ñ scheduled ‡∂∫‡∂± ‡∂Ø‡∑ô‡∂ö‡∑ô‡∑Ñ‡∑í‡∂∏ env object ‡∂ë‡∂ö mainLogic ‡∑Ä‡∑ô‡∂≠ ‡∂∫‡∑ê‡∑Ä‡∑í‡∂∫ ‡∂∫‡∑î‡∂≠‡∑î‡∂∫.
    async fetch(request, env, ctx) {
        ctx.waitUntil(mainLogic(env));
        return new Response("Forex Scraper Logic initiated successfully via Manual HTTP Request.", { status: 200 });
    },

    async scheduled(event, env, ctx) {
        ctx.waitUntil(mainLogic(env)); 
    }
};
